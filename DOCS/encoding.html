<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>

<HEAD>
  <TITLE>Encoding - MEncoder - The Movie Encoder for Linux</TITLE>
  <LINK REL="stylesheet" TYPE="text/css" HREF="default.css">
  <META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=iso-8859-1">
</HEAD>

<BODY>


<H2><A NAME="encoding">2.4 Encoding with MEncoder</A></H2>

<P>MEncoder (MPlayer's Movie Encoder) is a simple movie encoder,
  designed to encode MPlayer-playable movies
  (<B>AVI/ASF/OGG/DVD/VCD/VOB/MPG/MOV/VIV/FLI/RM/NUV/NET/PVA</B>) to other
  MPlayer-playable formats (see below). It can encode with various codecs, like
  <B>DivX4</B> (1 or 2 passes), libavcodec,
  <B>PCM</B>/<B>MP3</B>/<B>VBR MP3</B> audio. Also has powerful plugin system
  for video manipulation.</P>


<H3><A NAME="compilation">2.4.1 Compilation</A></H3>

<UL>
  <LI><B>OPTIONAL</B> - read MPlayer's compilation instruction.</LI>
  <LI><B>OPTIONAL (LINUX ONLY)</B> - download the newest <B>DivX4linux</B> libs
    from <A HREF="http://avifile.sourceforge.net/download.htm">avifile.sourceforge.net</A>,
    and have them PROPERLY installed. You need them if you want DivX4
    (1/2 pass) encoding.</LI>
  <LI><B>OPTIONAL</B> - <A HREF="codecs.html#xvid">download and install
    <B>XViD</B></A>. Not very useful, libavcodec's <I>mpeg4</I> codec
    can encode with much better speed AND quality than XViD or DivX4/5.</LI>
  <LI><B>OPTIONAL</B> - for libavcodec support, install libavcodec as
    described in the <A HREF="codecs.html#libavcodec">libavcodec section</A>.</LI>
  <LI><B>OPTIONAL</B> - download and compile <B>libmp3lame</B> (from lame 3.89beta or lame CVS).<BR>
    <B>WARNING: DO NOT COMPILE LAME &lt; 3.90 WITH <U>GCC 2.96</U>! It won't
    work properly!</B><BR>
    This
    is needed for CBR/VBR MP3 audio encoding ability. Note that a single
    <CODE>lame</CODE> binary isn't sufficient. BTW: the less optimization
    you use for lame, the better the quality will be. You can test
    quality by running <CODE>make test</CODE> after lame's compiling process
    is over. The resulting number should be less than <B>30</B>. Don't
    panic if it's <B>400</B> or so, you shouldn't heard any audible
    quality decrease. Oh, and if your compiler doesn't even run
    <CODE>make test</CODE> ... Well, delete that <B>GCC 2.96</B> or upgrade
    lame to at least <B>3.90</B>.</LI>
  <LI><B>OPTIONAL</B> - <CODE>libjpeg</CODE> and <CODE>libpng</CODE> -
    as described in the <A HREF="documentation.html#installation">Installation</A>
    section</LI>
</UL>

<P>You are ready. As you probably know, other encoding tools need the
  <I>avifile</I> library installed. MEncoder doesn't need it at all.</P>


<H3><A NAME="features">2.4.2 MEncoder features</A></H3>

<UL>
  <LI>encoding from the wide range of fileformats and decoders of MPlayer</LI>
  <LI>encoding to all the codecs of ffmpeg's
    <A HREF="codecs.html#libavcodec">libavcodec</A></LI>
  <LI>video encoding from <B>V4L compatible TV tuners</B></LI>
  <LI>encoding/multiplexing to interleaved AVI files with proper index</LI>
  <LI>creating files from external audio stream</LI>
  <LI>1, 2 or 3 pass encoding</LI>
  <LI><B>VBR</B> MP3 audio - <B>IMPORTANT NOTE:</B> VBR MP3 audio doesn't
    always play nicely on Windows players! On the other hand, currently
    MEncoder's CBR encoding is totally broken on Win32 players :)</LI>
  <LI>PCM audio</LI>
  <LI>stream copying</LI>
  <LI>input A/V synchronizing (PTS-based, can be disabled with -mc 0 option)</LI>
  <LI>FPS correction with <CODE>-ofps</CODE> option (useful when encoding
    29.97fps VOB to 24fps AVI)</LI>
  <LI>using our very powerful plugin system (crop, expand, flip, postprocess,
    rotate, scale, rgb/yuv conversion)</LI>
  <LI>can encode DVD/VOBsub <B>AND</B> text subtitles into the output file</LI>
  <LI>can rip DVD subtitles to Vobsub format</LI>
</UL>

<H4>Planned features:</H4>

<UL>
  <LI>even wider variety of available en/decoding formats/codecs
    (creating VOB files with DivX4/Indeo5/VIVO streams :)</LI>
  <LI>audio encoding from v4l (DONE for FreeBSD ?)</LI>
</UL>


<H4><A NAME="2pass">2.4.2.1 Encoding 2 or 3-pass DivX4</A></H4>

<P><U><B>2-pass encoding:</B></U> the name comes from the fact that this method
  encodes the file <I>twice</I>. The first encoding (dubbed <I>pass</I>)
  creates some temporary files (*.log) with a size of few megabytes, do not
  delete them yet (you can delete the AVI). In the second pass, the 2-pass
  output file is created, using the bitrate data from the temporary files. The
  resulting file will have much better image quality. If this is the first time
  you heard about this, you should consult some guides available on the
  Net.</P>

<P>This example shows how to encode a DVD to a 2-pass DivX4 AVI. Just two
  commands are needed:<BR>
  <CODE>&nbsp;&nbsp;&nbsp;&nbsp;rm frameno.avi</CODE> - remove this file, which
    can come from a previous 3-pass encoding (it interferes with current
    one)<BR>
  <CODE>&nbsp;&nbsp;&nbsp;&nbsp;mencoder -dvd 2 -ovc lavc -lavcopts
    vcodec=mpeg4:more_options -oac copy -o movie.avi -pass 1<BR>
  &nbsp;&nbsp;&nbsp;&nbsp;mencoder -dvd 2 -ovc lavc -lavcopts
    vcodec=mpeg4:more_options -oac copy -o movie.avi -pass 2</CODE></P>

<P><U><B>3-pass encoding:</B></U> this is an extension of 2-pass encoding,
  where the audio encoding takes place in a separate pass. This method enables
  estimation of recommended video bitrate in order to fit on a CD. Also, the
  audio is encoded only once, unlike in 2-pass mode. The schematics:</P>

<OL>
  <LI>Remove conflicting temporary file:
    <P><CODE>rm frameno.avi</CODE></P></LI>
  <LI>First pass:
    <P><CODE>mencoder &lt;file/DVD&gt; -ovc frameno -oac mp3lame -lameopts vbr=3:more_options -o frameno.avi</CODE></P>
    <P>An audio-only avi file will be created, containing
      <B>only</B> the requested audio stream. Don't forget <CODE>-lameopts</CODE>,
      if you need to set it. If you were encoding a long movie, MEncoder
      prints the recommended bitrate values for 650Mb, 700Mb, and 800Mb
      destination sizes, after this pass finishes.</P></LI>
  <LI>Second pass:
    <P><CODE>mencoder &lt;file/DVD&gt; -oac copy -pass 1
      -ovc lavc -lavcopts vcodec=mpeg4:vbitrate=&lt;bitrate&gt;</CODE></P>
    <P>Alias the first pass of DivX4 video encoding. 
      Optionally specify the video bitrate MEncoder printed at the end of
      the previous pass.</P></LI>
  <LI>Third pass:
    <P><CODE>mencoder &lt;file/DVD&gt; -oac copy -pass 2
      -ovc lavc -lavcopts vcodec=mpeg4:vbitrate=&lt;bitrate&gt;</CODE></P>
    <P>Alias the second pass of DivX4 video encoding. 
      Optionally specify the video bitrate MEncoder printed at the end of
      the previous pass. In this pass, audio from <CODE>frameno.avi</CODE> will
      be inserted into the destination file.. and it's all ready!</P></LI>
</OL>

<H4>Example for 3-pass encoding:</H4>

<P><CODE>&nbsp;&nbsp;&nbsp;&nbsp;rm frameno.avi</CODE> - remove this file,
  which can come from a previous 3-pass encoding (it interferes with current
  one)<BR>
  <CODE>&nbsp;&nbsp;&nbsp;&nbsp;mencoder -dvd 2 -ovc frameno
    -o frameno.avi -oac mp3lame -lameopts vbr=3:more_options<BR>
  &nbsp;&nbsp;&nbsp;&nbsp;mencoder -dvd 2 -ovc lavc
    -lavcopts vcodec=mpeg4:more_options -oac copy -o movie.avi -pass 1<BR>
  &nbsp;&nbsp;&nbsp;&nbsp;mencoder -dvd 2 -ovc lavc
    -lavcopts vcodec=mpeg4:more_options -oac copy -o movie.avi -pass 2</CODE></P>

<P><U><B>2 or 3-pass encoding using internal libavcodec controller:</B></U>
  Optionally you can use libavcodec's internal 2 or 3-pass mode, it may give
  you better final rate accuracy than using the external, DivX4-inspired 2-pass
  rate controler with libavcodec.</P>

<UL>
  <LI><B>2-pass encoding:</B><BR>
    <CODE>rm -f lavc_stats.txt<BR>
    mencoder -dvd 2 -ovc lavc -lavcopts vcodec=mpeg4:vpass=1 (audio-options) -o
      movie.avi<BR>
    mencoder -dvd 2 -ovc lavc -lavcopts vcodec=mpeg4:vpass=2 (audio-options) -o
      movie.avi</CODE></LI>
  <LI><B>3-pass encoding:</B><BR>
    <CODE>rm -f frameno.avi lavc_stats.txt<BR>
    mencoder -dvd 2 -ovc frameno (audio-options) -o frameno.avi<BR>
    mencoder -dvd 2 -ovc lavc -lavcopts vcodec=mpeg4:vpass=1 -oac copy -o
      movie.avi<BR>
    mencoder -dvd 2 -ovc lavc -lavcopts vcodec=mpeg4:vpass=2 -oac copy -o
      movie.avi</CODE></LI>
</UL>


<H4><A NAME="rescaling">2.4.2.2 Rescaling movies</A></H4>

<P>Often the need to resize movie images' size emerges. Its reasons can be many,
  examples are decreasing output file size, encoding SVCDs to DivX. Ripped DVDs
  are mostly rescaled, for example a 4:3 DVD should be 640x480, especially
  when you want it to fit to 1 CD, and have good quality at the same time.
  SVCDs have 480x480 size, and their header contains the aspect ratio the
  player should use (Ex.: 480x480 + 4:3 = 640x480). However when encoding to
  AVI (DivX) files, you have be aware that AVI headers don't store this
  value. Thus, the only solution is rescaling.</P>

<P>The scaling process is handled by the <I>'scale'</I> video filter:
  <CODE>-vop scale=X:Y</CODE>. Its quality can be set with the
  <CODE>-sws</CODE> option. If it's not specified, MEncoder will use 0:
  fast bilinear.</P>

<P>Usage:<BR>
  <CODE>&nbsp;&nbsp;&nbsp;&nbsp;mencoder sample-svcd.mpg -ovc lavc -lavcopts
    vcodec=mpeg4:more_options -vop scale=640:480 -oac copy -o
    output.avi</CODE></P>


<H4><A NAME="copying">2.4.2.3 Stream copying</A></H4>

<P>MEncoder can handle input streams in two ways: <B>encode</B> or
  <B>copy</B> them. This section is about <B>copying</B>.</P>

<UL>
  <LI><B>Video stream</B> (option <CODE>-ovc copy</CODE>): nice stuff can be
    done :)<BR>
    Like, putting (not converting) FLI or VIVO or MPEG1 video into
    an AVI file. Of course only MPlayer can play such files :) And it
    probably has no real life value at all. Rationally: video stream copying
    can be useful for example when only the audio stream has to be encoded
    (like, uncompressed PCM to MP3).</LI>

  <LI><B>Audio stream</B> (option <CODE>-oac copy</CODE>): straightforward.
    It is possible to take an external audio file (MP3, Vorbis) and mux it
    into the output stream. Use the <CODE>-audiofile &lt;filename&gt;</CODE>
    option for this.</LI>
</UL>


<H4><A NAME="fixing">2.4.2.4 Fixing AVIs with broken index or interleaving</A></H4>

<P>Easiest thing. We simply copy the video and audio streams, and
  MEncoder generates the index. Of course this cannot fix possible bugs
  in the video and/or audio streams. It also fixes files with broken
  interleaving, thus the <CODE>-ni</CODE> option won't be needed for them
  anymore.</P>

<P>Command: <CODE>mencoder -idx input.avi -ovc copy -oac copy -o output.avi</CODE></P>


<H4><A NAME="libavcodec">2.4.2.5 Encoding with the libavcodec codec family</A></H4>

<P><A HREF="codecs.html#libavcodec">libavcodec</A> provides simple encoding to a
  lot of interesting video and audio formats (currently its audio codecs are
  unsupported). You can encode to the following codecs:</P>

<UL>
  <LI>mjpeg - Motion JPEG</LI>
  <LI>h263 - H263</LI>
  <LI>h263p - H263 Plus</LI>
  <LI>mpeg4 - DivX4</LI>
  <LI>msmpeg4 - the old DivX</LI>
  <LI>msmpeg4v2 - Micro$oft MPEG4 V2 (DivX alias MP43 predecessor)</LI>
  <LI>rv10 - an old RealVideo codec</LI>
  <LI>mpeg1video - MPEG1 video :)</LI>
</UL>

<P>The first column contains the codec names that should be passed after the
  <CODE>vcodec</CODE> config, like: <CODE>-lavcopts vcodec=msmpeg4</CODE></P>

<P>An example, with MJPEG compression:<BR>
  <CODE>&nbsp;&nbsp;&nbsp;&nbsp;mencoder -dvd 2 -o title2.avi -ovc lavc
    -lavcopts vcodec=mjpeg -oac copy</CODE></P>


<H4><A NAME="image_files">2.4.2.6 Encoding from multiple input image files (JPEGs, PNGs or TGAs)</A></H4>

<P>MEncoder is capable of creating movies from one or more JPEG, PNG or TGA
  files. With simple framecopy it can create MJPEG (Motion JPEG), MPNG
  (Motion PNG) or MTGA (Motion TGA) files.</P>

Explanation of the process:

<OL>
  <LI>MEncoder <I>decodes</I> the input image(s) with
    <CODE>libjpeg</CODE> (when decoding PNGs, it will use <B>libpng</B>).</LI>

  <LI>MEncoder then feeds the decoded image to the chosen video compressor
    (DivX4, Xvid, ffmpeg msmpeg4, etc...). Watch for the PNG decoder, as
    currently it can output only to RGB formats, thus can't be used with codecs
    that require YUV as input, like DivX4 or ffmpeg's msmpeg4.</LI>
</OL>

<H4>Examples</H4>

<P>The explanation of the <CODE>-mf</CODE> option can be found below in the
  global <A HREF="#options">Options</A> section and in the man page.</P>

<P><I>Creating a DivX4 file from all the JPEG files in the current dir:</I><BR>
  &nbsp;&nbsp;<CODE>mencoder \*.jpg -mf on:w=800:h=600:fps=25 -ovc divx4
  -oac copy -o output.avi</CODE></P>

<P><I>Creating a DivX4 file from some JPEG files in the current dir:</I><BR>
  &nbsp;&nbsp;<CODE>mencoder frame001.jpg,frame002.jpg -mf on:w=800:h=600:fps=25
  -ovc divx4 -oac copy -o output.avi</CODE></P>

<P><I>Creating a Motion JPEG (MJPEG) file from all the JPEG files in the current dir:</I><BR>
  &nbsp;&nbsp;<CODE>mencoder \*.jpg -mf on:w=800:h=600:fps=25 -ovc copy
  -oac copy -o output.avi</CODE></P>

<P><I>Creating an uncompressed file from all the PNG files in the current dir:</I><BR>
  &nbsp;&nbsp;<CODE>mencoder \*.png -mf on:w=800:h=600:fps=25:type=png -ovc raw
  -oac copy -o output.avi</CODE></P>

<P><I>Creating a Motion PNG (MPNG) file from all the PNG files in the current dir:</I><BR>
  &nbsp;&nbsp;<CODE>mencoder \*.png -mf on:w=800:h=600:fps=25:type=png -ovc copy
  -oac copy -o output.avi</CODE></P>

<P><I>Creating a Motion TGA (MTGA) file from all the TGA files in the current dir:</I><BR>
  &nbsp;&nbsp;<CODE>mencoder \*.tga -mf on:w=800:h=600:fps=25:type=tga -ovc copy
  -oac copy -o output.avi</CODE></P>


<H4><A NAME="vobsub">2.4.2.7 Extracting DVD subtitles to Vobsub file</A></H4>

<P>MEncoder is capable of extracting subtitles from a DVD into
  Vobsub fomat files. They consist of a pair of files ending in
  <CODE>.idx</CODE> and <CODE>.sub</CODE> and are usually packaged in a single
  <CODE>.rar</CODE> archive. MPlayer can play these with the
  <CODE>-vobsub</CODE> and <CODE>-vobsubid</CODE> options.</P>

<P>You specify the basename (i.e without the <CODE>.idx</CODE> or
  <CODE>.sub</CODE> extension) of the output files with <CODE>-vobsubout</CODE>
  and the index for this subtitle in the resulting files with
  <CODE>-vobsuboutindex</CODE>.</P>

<P>If the input is not from a DVD you should use <CODE>-ifo</CODE> to
  indicate the <CODE>.ifo</CODE> file needed to construct the resulting
  <CODE>.idx</CODE> file.</P>

<P>If the input is not from a DVD and you do not have the <CODE>.ifo</CODE>
  file you will need to use the <CODE>-vobsubid</CODE> option to let it know
  what language id to put in the <CODE>.idx</CODE> file.</P>

<P>Each run will append the running subtitle if the <CODE>.idx</CODE> and
  <CODE>.sub</CODE> files already exist. So you should remove any before
  starting.</P>

<H4>Examples</H4>

<P><I>Copying two subtitles from a DVD while doing 3-pass encoding</I><BR>
  &nbsp;&nbsp;<CODE>rm subtitles.idx subtitles.sub</CODE><BR>
  &nbsp;&nbsp;<CODE>mencoder -dvd 1 -vobsubout subtitles -vobsuboutindex 0
    -sid 2 -o frameno.avi -ovc frameno -oac mp3lame -lameopts vbr=3</CODE><BR>
  &nbsp;&nbsp;<CODE>mencoder -dvd 1 -oac copy -ovc divx4 -pass 1</CODE><BR>
  &nbsp;&nbsp;<CODE>mencoder -dvd 1 -oac copy -ovc divx4 -pass 2 -vobsubout
    subtitles -vobsuboutindex 1 -sid 5</CODE></P>

<P><I>Copying a french subtitle from an MPEG file</I><BR>
  &nbsp;&nbsp;<CODE>rm subtitles.idx subtitles.sub</CODE><BR>
  &nbsp;&nbsp;<CODE>mencoder movie.mpg -ifo movie.ifo -vobsubout subtitles
    -vobsuboutindex 0 -vobsuboutid fr -sid 1</CODE></P>


<H3><A NAME="options">2.4.3 Available options</A></H3>

<P>For the complete list of available MEncoder options and examples,
  please see the man page.</P>

</BODY>
</HTML>
